---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->



```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```



# OpenLand <img src='man/figures/logo.png' align="right" height="139" />


<!-- badges: start -->
[![Travis build status](https://travis-ci.org/reginalexavier/OpenLand.svg?branch=master)](https://travis-ci.org/reginalexavier/OpenLand)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/reginalexavier/OpenLand?branch=master&svg=true)](https://ci.appveyor.com/project/reginalexavier/OpenLand)
[![Codecov test coverage](https://codecov.io/gh/reginalexavier/OpenLand/branch/master/graph/badge.svg)](https://codecov.io/gh/reginalexavier/OpenLand?branch=master)
<!-- badges: end -->

OpenLand is an open-source R package for the analysis of land use and cover (LUC) time series. It includes support for consistency check and loading spatiotemporal raster data and synthesized spatial plotting. Several LUC change (LUCC) metrics in regular or irregular time intervals can be extracted and visualized through one- and multistep sankey and chord diagrams. A complete intensity analysis according to (Aldwaik and Pontius 2012) is implemented, including tools for the generation of standardized multilevel output graphics.


## Installation

You can install OpenLand from github with:


```{r installation, eval = FALSE}
devtools::install_github("reginalexavier/OpenLand")
```


## Illustrative Example

This is a basic example which shows how OpenLand works, for a more detailed illustration, please see our vignettes.

The OpenLand functionality is illustrated for a LUC dataset of São Lourenço river basin, a major Pantanal wetland contribution area as provided by the 4^th^ edition of the [Monitoring of Changes in Land cover and Land Use in the Upper Paraguay River Basin - Brazilian portion - Review Period: 2012 to 2014](https://www.embrapa.br/pantanal/bacia-do-alto-paraguai) (Embrapa Pantanal, Instituto SOS Pantanal, and WWF-Brasil 2015). The time series is composed by five LUC maps (2002, 2008, 2010, 2012 and 2014). The study area of approximately 22,400 km^2^ is located in the Cerrado Savannah biom in the southeast of the Brazilian state of Mato Grosso.
For processing in the OpenLand package, the original multi-year shape file was transformed into rasters and then saved as a 5-layer `RasterStack`, which is included in the OpenLand package as `SaoLourencoBasin`. For  further details about this object, run `help("SaoLourencoBasin")` or `?SaoLourencoBasin` in the R console.

```{r example}
# Loading the package
library(OpenLand)

```



##### **What is Intensity Analysis?**
Intensity Analysis (IA) is a quantitative method to analyze LUC maps at several time steps, using cross-tabulation matrices, where each matrix summarizes the LUC change at each time interval. IA evaluates in three levels the deviation between observed change intensity and hypothesized uniform change intensity. Hereby, each level details information given by the previous analysis level. First, the **interval level** indicates how size and rate of change varies across time intervals. Second, the **category level** examines for each time interval how the size and intensity of gross losses and gross gains in each category vary across categories for each time interval. Third, the **transition level** determines for each category how the size and intensity of a category’s transitions vary across the other categories that are available for that transition. At each level, the method tests for stationarity of patterns across time intervals (Aldwaik and Pontius 2012).



### Outcomes of intensity analysis

The data is extracted from the rasters with the `contingencyTable()` function which returns a multiple grid information in tables for the next processing steps.  Within the OpenLand package, the `intensityAnalysis()` function computes the three levels of analysis. It requires the object returned by the `contingenceTable()` function and that the user predefines two LUC categories `n` and `m`. Generally, `n` is a target category which experienced relevant gains and `m` a category with important losses.

```{r include=FALSE}
## editing the classe name
SL_2002_2014$tb_legend$className <- factor(c("Ap", "FF", "SA", "SG", "aa", "SF", 
                                          "Agua", "Iu", "Ac", "R", "Im"),
                                  levels = c("FF", "SF", "SA", "SG", "aa", "Ap", 
                                         "Ac", "Im", "Iu", "Agua", "R"))

## add the color by the same order of the legend,
## it can be the colour name (eg. "black") or the HEX value (eg. #000000)
SL_2002_2014$tb_legend$color <- c("#FFE4B5", "#228B22", "#00FF00", "#CAFF70", 
                                  "#EE6363", "#00CD00", "#436EEE", "#FFAEB9", 
                                  "#FFA54F", "#68228B", "#636363")

## now we have
SL_2002_2014$tb_legend

```

```{r}
testSL <- intensityAnalysis(dataset = SL_2002_2014,
                            class_n = "Ap", class_m = "SG")

# it returns a list with 6 objects
names(testSL)

```



The `intensityAnalysis()` function returns `r length(testSL)` objects: `r names(testSL)`.
Here, we adopted an object-oriented approach that allows to set specific methods for plotting the intensity objects. Specifically, we used the S4 class, which requires the formal definition of classes and methods (Chambers 2008).




#### Presentation of an intensity object

In this example we will show an object from ``r class(testSL[[4]])`` class. A ``r class(testSL[[4]])`` object contains three slots: the first contains the colors associated with the legend items as name attributes, the second slot contains a table of the **category level** result _(gain (G~tj~) or loss (L~ti~) values)_  and the third slot contains a table storing the results of a stationarity test.

```{r}

testSL$category_lvlGain

```


#### Ploting an intensity object

Visualizations of the IA results are obtained from the `plot(intensity-object)` function. For more details on the function arguments, please see the documentation of the `plot()` method.

```{r, cat_level, echo=TRUE, fig.align='center', fig.cap="Gain area outcome - Category level", out.width="80%", dev.args=list(pointsize=10), dpi=150}

plot(testSL$category_lvlGain,
     labels = c(leftlabel = bquote("Gain Area (" ~ km ^ 2 ~ ")"),
                rightlabel = "Intensity Gain (%)", title = NA),
     marginplot = c(.3, .3), labs = c("Classes", "Uniform intensity"), 
     leg_curv = c(x = 1, y = .5),
     fontsize_ui = 8)

```


### Miscellaneous visualization tools

OpenLand provides a bench of visualization tools of LUCC metrics. One-step transitions can be balanced by net and gross changes of all classes through a combined bar chart. Transitions between LUC classes can be detailed by a circular chord chart, based on the Circlize package (Gu et al. 2014). An implementation of Sankey diagram based on the networkD3 package (Allaire et al. 2017) allow the representation of one- and multistep LUCC between classes. Areal development of all LUC classes throughout the observation period can be visualized by a grouped bar chart.


##### Net and Gross gain and loss

```{r ng_plot, echo=TRUE, fig.align='center', fig.cap="Net Gross Changes 2002 - 2014", out.width="80%", dev.args=list(pointsize=10), dpi=150}

netgrossplot(dataset = SL_2002_2014$lulc_Multistep,
             legendtable = SL_2002_2014$tb_legend,
             title = NULL,
             xlab = "Classes de UCT",
             ylab = bquote("Area (" ~km^2~")"),
             changes = c(GC = "Gross changes", NG = "Net Gain", NL = "Net Loss"),
             color = c(GC = "gray70", NG = "#006400", NL = "#EE2C2C")
             )

```


##### Chord Diagram (2002 - 2014)

```{r chordDiagram, echo=TRUE, fig.align='center', fig.cap="Chord Diagram 2002 - 2014 (area in km^2^)", dev.args=list(pointsize=9.5), dpi=400}

chordDiagramLand(dataset = SL_2002_2014$lulc_Onestep,
                 legendtable = SL_2002_2014$tb_legend)

```

##### Sankey Multi Step (2002, 2008, 2010, 2012, 2014)

```{r, fig.width=7, fig.height=4}

# sankeyLand(dataset = SL_2002_2014$lulc_Multistep,
#            legendtable = SL_2002_2014$tb_legend)


```

```{r sankey_multi, out.width='80%',echo=FALSE,fig.align='center', dpi=300}
knitr::include_graphics("man/figures/sankey_multi.png")
```


#### Other functions

OpenLand enables furthermore the spatial screening of LUCC frequencies for one or a series of raster layers with  `summary_map()` and `summary_dir()`. The `acc_changes()` function returns for a LUC time series the number of times a pixel has changed during the analysed period, returning a grid layer and a table with the percentages of transition numbers in the study area. Here we use the [tmap](https://github.com/mtennekes/tmap) package for ploting the outcomes of the `acc_changes()` function.

```{r mymap, echo=FALSE, fig.cap='Accumulate changes in pixel in the interval 2002 - 2014 in four time points (2002, 2008, 2010, 2012, 2014)', out.width='90%',fig.align='center'}

knitr::include_graphics("man/figures/acc_mymap.png")

```


## References

Aldwaik, Safaa Zakaria, and Robert Gilmore Pontius. 2012. “Intensity analysis to unify measurements of size and stationarity of land changes by interval, category, and transition.” Landsc. Urban Plan. 106 (1): 103–14. https://doi.org/10.1016/j.landurbplan.2012.02.010.

Allaire, J J, Christopher Gandrud, Kenton Russell, and C J Yetman. 2017. “networkD3: D3 JavaScript Network Graphs from R.” https://cran.r-project.org/package=networkD3.

Chambers, John. 2008. Software for Data Analysis. Statistics and Computing. New York, NY: Springer New York. https://doi.org/10.1007/978-0-387-75936-4.

Embrapa Pantanal, Instituto SOS Pantanal, and WWF-Brasil. 2015. “Mapeamento da Bacia do Alto Paraguai.” https://www.embrapa.br/pantanal/bacia-do-alto-paraguai.

Gu, Zuguang, Lei Gu, Roland Eils, Matthias Schlesner, and Benedikt Brors. 2014. “circlize implements and enhances circular visualization in R.” Bioinformatics 30 (19): 2811–2.
