---
title: "Quick intro for OpenLand Package"
output: rmarkdown::html_vignette
bibliography: papers_OpenLand.bib
vignette: >
  %\VignetteIndexEntry{Quick Intro for OpenLand Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
body {
text-align: justify}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



----
**This is a Vignette on how to use the OpenLand package into Land Use and Land Cover (LULC)
data manipulation and producing visualisations.**

## Description of the tools

OpenLand is an open-source R package for the analysis of land use and land cover
time series. It includes support for loading spatiotemporal data `raster map`; 
simulating landscapes with some degree of spatial correlation; extraction of
land use transition matrices; computing of net change and gross changes in a given 
interval; performing a complete intensity analysis based on [@Aldwaik2012]. It provides
methods for visualizations of land use and land cover change like 
the outcomes of intensity analysis, as other graphs like sankey diagram 
(onestep or multistep) and chord diagram displaying the inter-relationships 
between the land uses.

## Case Study (São Lourenço river Basin)
For this work, we used the map (shapefile) from the 4th edition of the [Monitoring 
of Changes in Land cover and Land Use in the Upper Paraguay River 
Basin - Brazilian portion - Review Period: 2012 to 2014](https://www.embrapa.br/pantanal/bacia-do-alto-paraguai) [@Embrapapantanalsite2015], which covers the specifically the years (2002, 2008, 2010, 2012 and 2014).


The study area of this research is the São Lourenço river basin, it is located in 
the southeast of Mato Grosso State, extending over an area of approximately 22,418 km^2^ 
and has experienced significant changes in the LULC during the last decades, including 
deforestation and intensification of existing agricultural uses.

The shapefile was transformed into rasters and then saved as 5-layer `RasterStack`, 
included as data in the OpenLand package as `SaoLourencoBasin` (for detail over this object, run `help("SaoLourencoBasin")` or `?SaoLourencoBasin` in the console).

### Step One
The first function is the `contingencyTable()`, this function take a list of raster
layer (`RasterBrick`, `RasterStack` or a path to folder conataining the rasters). The name
of the rasters must be in the format ("sometext" `+` "underscore" `+` "the-year") like "landscape_2019".

In our example we have the `SaoLourencoBasin` RasterStack, that can be seeing from
running `data(SaoLourencoBasin)` as following:

```{r setup}
# First we load the OpenLand package
library(OpenLand)

data(SaoLourencoBasin)

SaoLourencoBasin

```
```{r fig.height=5, fig.width=7}
sp::spplot(SaoLourencoBasin)
```


tmap::tm_shape(SaoLourencoBasin) +
tmap::tm_raster()

sp::spplot(SaoLourencoBasin)

### Step two

In this step we have to  extract the values from our rasters and save them for 
further use. The function in `OpenLand` that compute this is the `contingencyTable()`.
This function returns `r length(SL_2002_2014)` objects: `r names(SL_2002_2014)`.

The two first objects are tables of contingency, the first one takes into account all
the points in time and the second only the first year and the last of the series.
The third object is a table containing the class name associate with every pixel
value and a color to be associate (important for the plots). The values in classe
and color are been created aleatory by `contingencyTable()` function. These values
must be edited to the real values corresponding the data to be analysed.
The fourth object is a table containing the total area of study in km^2^ and in pixel unit and 
the fifth is the total interval between the first year (Y~t~) and the last year(Y~T~) in year unit.


A prototype of these tables is as following:

|[Y~_t_~, Y~_t+1_~] | Category~_i_~ | Category~_j_~ |C~_tij_~(km^2^)|C~_tij_~(pixel)|Y~_t+1_~ - Y~_t_~|Y~_t_~|Y~_t+1_~|
|:------------:|:----------:|:----------:|:--------------:|:--------------:|:------------:|:----:|:----:|
|`chr`|`int`|`int`|`dbl`|`int`|`int`|`int`|`int`|
|Period of analysis from time point _t_ to time point _t+1_|A category at interval’s initial time point|A category at  interval’s final time point|Number of elements in km^2^ that transits from category _i_ to category _j_|Number of elements in pixel that transits from category _i_ to category _j_|Interval in years between time point _t_ and time point _t+1_|Initial Year of the interval| Final Year of the interval|
|Period|From|To|km2|QtPixel|Interval|yearFrom|yearTo|

> For the second table,  the difference Y~_t+1_~ terms are repced by Y~_T_~, where T 
is the number of time points, i.e., Y~_T_~ is the last year of the series.



For our study area running the function `contingenceTable(input_raster = SaoLourencoBasin, pixelresolution = 30)`, we have this returns:



```{r}

# SL_2002_2014 <- contingenceTable(input_raster = SaoLourencoBasin, pixelresolution = 30)

SL_2002_2014

```

#### Step 3.1
Like mentioned before, the `r names(SL_2002_2014[3])` object must be edit with the real
classe name and colors associate with everyone of the classe value. In our case the
classes names and colors are based on @sospantanal2015.

|Pixel Value|Legend|Class|Use|Details|
|:---|:-----:|:-----------------|:-------------------|:------------------------------|
|2        | Ap     | Anthropic | Anthropic Use | Pastagem    |
|3        | FF     | Natural   | NA            | Formações Florestais |
|4        | SA     | Natural   | NA            | Savana Arborizada (SA - Cerrado)  |
|5        | SG     | Natural   | NA            | Savana Gramínea (SG - Campo) |
|7        | aa     | Anthropic | NA            | Alteração Antrópica |
|8        | SF     | Natural   | NA            | Savana Florestada (SF - Cerradão) |
|9        | Agua   | Natural   | NA            | Rios, córregos, corixos, vazantes, baías e salinas  
|10       | Iu     | Anthropic | Anthropic Use | Influencia Urbana   |
|11       | Ac     | Anthropic | Anthropic Use | Agricultura           |
|12       | R      | Anthropic | Anthropic Use | Reflorestamento   |
|13       | Im     | Anthropic | Anthropic Use | Degradação por Mineração|



```{r echo=TRUE}
# editing the classe name
SL_2002_2014$tb_legend$className <- factor(c("Ap", "FF", "SA", "SG", "aa", "SF", 
                                          "Agua", "Iu", "Ac", "R", "Im"),
                                  levels = c("FF", "SF", "SA", "SG", "aa", "Ap", 
                                         "Ac", "Im", "Iu", "Agua", "R"))

# add the color by the same order of the legend,
# it can be the colour name (eg. "black") or the HEX value (eg. #000000)
SL_2002_2014$tb_legend$color <- c("#FFE4B5", "#228B22", "#00FF00", "#CAFF70", 
                                  "#EE6363", "#00CD00", "#436EEE", "#FFAEB9", 
                                  "#FFA54F", "#68228B", "#636363")

# now we have
SL_2002_2014$tb_legend

```



```{r eval=FALSE, include=FALSE}
knitr::kable(
caseStudy$lulc_Mulstistep[1:10, ]
)
```


At this point one can choose to run theIntensity Analysis or creating a sankey, 
chord diagram and bar plot that not depends on the returns of the intensity function.


## Intensity Analysis

```{r}
testSL <- intensityanalysis(dataset = SL_2002_2014,
                            class_n = "Ap", class_m = "SG")

# it's returns a list with 10 objects
names(testSL)
```

## The graphics


### Interval Level

```{r, fig.width=7, fig.height=4}

plot(testSL$interval_lvl)

```

### Category Level

* Gain

```{r, fig.width=7, fig.height=4}

plot(testSL$category_lvlGain)

```

* Loss
```{r, fig.width=7, fig.height=4}

plot(testSL$category_lvlLoss)

```

### Transition Level

* Gain
```{r, fig.width=7, fig.height=4}

plot(testSL$transition_lvlGain_n)

```

* Loss
```{r, fig.width=7, fig.height=4}

plot(testSL$transition_lvlLoss_m)

```

## Net and Gross gain and loss

```{r fig.width=7, fig.height=4}

netgrossplot(dataset = SL_2002_2014$lulc_Multistep, # gross gain and loss
             legendtable = SL_2002_2014$tb_legend,
             title = NULL)

```


## Chord Diagram (2002 - 2014)

```{r fig.width=7, fig.height=6}

circlizeplot(dataset = SL_2002_2014$lulc_Onestep,
             legendtable = SL_2002_2014$tb_legend)

```

## Sankey Multi Step

```{r, fig.width=8, fig.height=4}

sankeyLand(dataset = SL_2002_2014$lulc_Multistep,
           legendtable = SL_2002_2014$tb_legend)


```


```
           2002                 2008                2010                  2012                  2014
```

## Sankey One Step

```{r, fig.width=8, fig.height=4}

sankeyLand(dataset = SL_2002_2014$lulc_Onestep,
           legendtable = SL_2002_2014$tb_legend)

```
```
                          2002                                                  2014
```

## An Evolution Bar Plot

```{r, fig.width=7, fig.height=4}

anualplot(dataset = SL_2002_2014$lulc_Multistep, 
          legendtable = SL_2002_2014$tb_legend,
          area_km2 = T)
```



# References
