---
title: "Quick intro for OpenLand Package"
output: rmarkdown::html_vignette
bibliography: papers_OpenLand.bib
vignette: >
  %\VignetteIndexEntry{Quick Intro for OpenLand Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
body {
text-align: justify}
</style>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



----
**This is a Vignette on how to use the OpenLand package into Land Use and Land Cover (LULC) data manipulation and producing visualizations.**

## Description of the tool

OpenLand is an open-source R package for the analysis of land use and land cover time series. It includes support for loading spatiotemporal data `raster map`; computing of net change and gross changes in a given interval; performing a complete intensity analysis based on [@Aldwaik2012]. It provides methods for visualizations of land use and land cover change like the outcomes of intensity analysis, as other graphs like sankey diagram (one-step or multistep) and chord diagram displaying the inter-relationships between the land uses.

## São Lourenço river Basin Case Study

For the illustrative case of study, we're going to use the map (shape file) from the 4Th edition of the [Monitoring of Changes in Land cover and Land Use in the Upper Paraguay River Basin - Brazilian portion - Review Period: 2012 to 2014](https://www.embrapa.br/pantanal/bacia-do-alto-paraguai) [@Embrapapantanalsite2015], which covers specifically the years (2002, 2008, 2010, 2012 and 2014).

The study area of this research is the São Lourenço river basin, it is located in the southeast of Mato Grosso State, extending over an area of approximately 22,418 km^2^ and has experienced ~~significant~~ changes (12%) in the LULC during the [2002 - 2014]'s period ~~last decades~~, including deforestation and intensification of existing agricultural uses.

The shape file was transformed into rasters and then saved as a 5-layers `RasterStack`, included as data in the OpenLand package as `SaoLourencoBasin` (for  further details over this object, run `help("SaoLourencoBasin")` or `?SaoLourencoBasin` in the console).

### The input data
The first function used to extract the data is the `contingencyTable()`, this function take a list of raster layer (`RasterBrick`, `RasterStack` or a path to a folder containing the rasters). The name of the rasters must be in the format ("some_text" `+` "underscore" `+` "the_year") like "landscape_2019".

In our example we have the `SaoLourencoBasin` RasterStack, that can be seeing from running `data(SaoLourencoBasin)` as following:

```{r setup}
## First we load the OpenLand package
library(OpenLand)

data(SaoLourencoBasin)

SaoLourencoBasin

```
```{r eval=FALSE, fig.height=5, fig.width=7, include=FALSE}
#sp::spplot(SaoLourencoBasin)
```



### Extracting the data from the raster series

In this step the values from the input raster layers are extracted and saved in tables for next processing steps. The function in `OpenLand` that compute that is the `contingencyTable()`. This function returns `r length(SL_2002_2014)` objects: `r names(SL_2002_2014)`.

The first two objects are tables of contingency, the first one (**`r names(SL_2002_2014)[1]`**) takes into account all the points in time and the second (**`r names(SL_2002_2014)[2]`**) only the first year and the last year of the series. The third object (**`r names(SL_2002_2014)[3]`**) is a table containing the class name associate with every pixel value and a color to be associate with _(important for the plots)_. The values in class and color are have been created aleatory by `contingencyTable()` function. These values must be edited to the real values corresponding the data to be analysed. The fourth object (**`r names(SL_2002_2014)[4]`**) is a table containing the total area of study in km^2^ and in pixel unit and the fifth (**`r names(SL_2002_2014)[5]`**) is the total interval between the first year (Y~t=1~) and the last year(Y~T~) in year unit.


Here a prototype of the contingency table created by the `contingencyTable` function:

|[Y~_t_~, Y~_t+1_~] | Category~_i_~ | Category~_j_~ |C~_tij_~(km^2^)|C~_tij_~(pixel)|Y~_t+1_~ - Y~_t_~|Y~_t_~|Y~_t+1_~|
|:------------:|:----------:|:----------:|:--------------:|:--------------:|:------------:|:----:|:----:|
|`chr`|`int`|`int`|`dbl`|`int`|`int`|`int`|`int`|
|Period of analysis from time point _t_ to time point _t+1_|A category at interval’s initial time point|A category at  interval’s final time point|Number of elements in km^2^ that transits from category _i_ to category _j_|Number of elements in pixel that transits from category _i_ to category _j_|Interval in years between time point _t_ and time point _t+1_|Initial Year of the interval| Final Year of the interval|
|**Period**|**From**|**To**|**km2**|**QtPixel**|**Interval**|**yearFrom**|**yearTo**|

> For the second table,  the Y~_t+1_~ terms are repced by Y~_T_~, where T is the number of time points, i.e., Y~_T_~ is the last year of the series.



For our study area running the function `contingenceTable(input_raster = SaoLourencoBasin, pixelresolution = 30)`, we have this returns:



```{r}

# SL_2002_2014 <- contingenceTable(input_raster = SaoLourencoBasin, pixelresolution = 30)

SL_2002_2014

```

#### Editing the values in ``r names(SL_2002_2014$tb_legend[2])`` and ``r names(SL_2002_2014$tb_legend[3])`` columns
As mentioned before, the **`r names(SL_2002_2014[3])`** object must be edited with the real class name and colors associate with everyone of the class value. In our case the classes names and colors are based on @sospantanal2015 [(acces document here, page 17)](https://www.embrapa.br/documents/1354999/1529097/BAP+-+Mapeamento+da+Bacia+do+Alto+Paraguai+-+estudo+completo/e66e3afb-2334-4511-96a0-af5642a56283).

|Pixel Value|Legend|Class|Use|Details|color|
|:---|:-----:|:-----------------|:-------------------|:------------------------------|:------|
|2        | Ap     | Anthropic | Anthropic Use | Pastagem                            |#FFE4B5|
|3        | FF     | Natural   | NA            | Formações Florestais                |#228B22|
|4        | SA     | Natural   | NA            | Savana Arborizada (SA - Cerrado)    |#00FF00|
|5        | SG     | Natural   | NA            | Savana Gramínea (SG - Campo)        |#CAFF70|
|7        | aa     | Anthropic | NA            | Alteração Antrópica                 |#EE6363|
|8        | SF     | Natural   | NA            | Savana Florestada (SF - Cerradão)   |#00CD00|
|9        | Agua   | Natural   | NA            | Rios, córregos, corixos, vazantes, baías e salinas|#436EEE|
|10       | Iu     | Anthropic | Anthropic Use | Influencia Urbana                   |#FFAEB9|
|11       | Ac     | Anthropic | Anthropic Use | Agricultura                         |#FFA54F|
|12       | R      | Anthropic | Anthropic Use | Reflorestamento                     |#68228B|
|13       | Im     | Anthropic | Anthropic Use | Degradação por Mineração            |#636363|



```{r echo=TRUE}
## editing the classe name
SL_2002_2014$tb_legend$className <- factor(c("Ap", "FF", "SA", "SG", "aa", "SF", 
                                          "Agua", "Iu", "Ac", "R", "Im"),
                                  levels = c("FF", "SF", "SA", "SG", "aa", "Ap", 
                                         "Ac", "Im", "Iu", "Agua", "R"))

## add the color by the same order of the legend,
## it can be the colour name (eg. "black") or the HEX value (eg. #000000)
SL_2002_2014$tb_legend$color <- c("#FFE4B5", "#228B22", "#00FF00", "#CAFF70", 
                                  "#EE6363", "#00CD00", "#436EEE", "#FFAEB9", 
                                  "#FFA54F", "#68228B", "#636363")

## now we have
SL_2002_2014$tb_legend

```



```{r eval=FALSE, include=FALSE}
knitr::kable(
caseStudy$lulc_Mulstistep[1:10, ]
)
```


> At this point one can choose to run the Intensity Analysis or creating some representations provided by the `OpenLand` package like sankey diagram with `sankeyLand()` function, a chord diagram with `chordDiagramLand()` or a bar plot showing the evolution trough the years analysed with `barplotLand()` since they don't depend on the intensity function returns.


## Intensity Analysis
The intensity analysis is a quantitative method to analyze maps of land categories from several points in time for a single site by considering cross-tabulation matrices, where one matrix summarizes the change in each time interval. There are three levels of analysis, starting from general to more detailed levels, where each level exposes different types of information given the previous level of analysis. First, the **interval level** examines how the size and speed of change vary across time intervals. Second, the **category level** examines how the size and intensity of gross losses and gross gains in each category vary across categories for each time interval. Third, the **transition level** examines how the size and intensity of a category’s transitions vary across the other categories that are available for that transition. At each level, the method tests for stationarity of patterns across time intervals [@Aldwaik2012].

Within the OpenLand package we have created a function `intensityAnalysis()` that compute the three levels of analysis. It requires the object returned by the `contingenceTable()` function, and the categories `n` and `m` chosen by the user.

```{r}
testSL <- intensityAnalysis(dataset = SL_2002_2014,
                            class_n = "Ap", class_m = "SG")

# it's returns a list with 6 objects
names(testSL)

```

The function returns `r length(testSL)` objects: `r names(testSL)`.
On this part we adopted an object-oriented approach that allows us to setting specifics methods for plotting the intensity objects created by the `intensityanalysis()` function. The system we use is the S4 class which requires classes and methods to be formally define [@Chambers2008]. The first object is a contingency table like the `r names(SL_2002_2014)[1]` object with the unique difference that is, the column `From` and `To` values have has been replaced by their appropriate legend.

The second object _**`r names(testSL[2])`**_ is an ``r class(testSL[[2]])`` object the third _**`r names(testSL[3])`**_ and the fourth _**`r names(testSL[4])`**_ are ``r class(testSL[[4]])`` objects,  the fifth _**`r names(testSL[5])`**_ and the sixth _**`r names(testSL[6])`**_ are ``r class(testSL[[6]])`` objects.

An ``r class(testSL[[2]])`` object contains one slot containing a table of  **interval level**'s result _(S~t~ and U values)_. A ``r class(testSL[[4]])`` object contains three slots: the first contains the colors associate with the data with the legends as name's attribute, the second slot contains a table of the **category level**'s result _(gain (G~tj~) or loss (L~ti~) values)_  and the third slot contains a table saving a stationarity test. A ``r class(testSL[[6]])`` object contains three slots: the first contains the colors associate with the data with the legends as name's attribute, the second slot contains a table of the **transition level**'s result _(gain n (R~tin~ & W~tn~) or loss m (Q~tmj~ & V~tm~) values)_ and the fourth slot contains a table saving a stationarity test.

> @Aldwaik2012 considers a stationary case only whether the intensities for all time intervals reside on one side of the uniform intensity, i.e, smaller or bigger than the uniform rate over the whole period.


```{r}
# showing the objects from the intensity analysis for our illustrative case
testSL

```



## The Graphs 

### Outcomes of intensity analysis

Visualizations of the intensity analysis result is obtaining from the plot(intensity-object) function, for a more detailed over the parameters see function's documentation.


#### Interval Level

```{r, fig.width=7, fig.height=4}

plot(testSL$interval_lvl,
     labels = c(leftlabel = "Interval Change Area (%)",
                rightlabel = "Annual Change Area (%)",
                title = NA),
     marginplot = c(-8, 0), labs = c("Changes", "Uniform Rate"))

```

#### Category Level

* Gain Area

```{r, fig.width=7, fig.height=4}

plot(testSL$category_lvlGain,
     labels = c(leftlabel = bquote("Gain Area (" ~ Km ^ 2 ~ ")"),
                rightlabel = "Intensity Gain (%)", title = NA),
     marginplot = c(.3, .3), labs = c("Classes", "Uniform Rate"))


```

* Loss Area
```{r, fig.width=7, fig.height=4}

plot(testSL$category_lvlLoss,
     labels = c(leftlabel = bquote("Loss Area (" ~ Km ^ 2 ~ ")"),
                rightlabel = "Loss Intensity (%)", title = NA),
     marginplot = c(.3, .3), labs = c("Classes", "Uniform Rate"))

```

#### Transition Level

* Gain of Ap
```{r, fig.width=7, fig.height=4}

plot(testSL$transition_lvlGain_n,
     labels = c(rightlabel = "Intensity Gain of Ap (%)",
                leftlabel = bquote("Gain of Ap (" ~ Km ^ 2 ~ ")"),
                title = NA),
     marginplot = c(.3, .3), labs = c("Classes", "Uniform Rate"))

```

* Loss of SG
```{r, fig.width=7, fig.height=4}

plot(testSL$transition_lvlLoss_m,
     labels = c(rightlabel = "Intensity Loss of SG (%)",
                leftlabel = bquote("Loss of SG (" ~ Km ^ 2 ~ ")"),
                title = NA),
     marginplot = c(.3, .3), labs = c("Classes", "Uniform Rate"))

```

### Other graphs

#### Net and Gross gain and loss

```{r fig.width=7, fig.height=4}

netgrossplot(dataset = SL_2002_2014$lulc_Multistep, # gross gain and loss
             legendtable = SL_2002_2014$tb_legend,
             title = NULL,
             xlab = "Classes de UCT",
             changes = c(GC = "Gross changes", NG = "Net Gain", NL = "Net Loss"),
             color = c(GC = "gray70", NG = "#006400", NL = "#EE2C2C")
             #color = c(GC = "gray70", NG = "green", NL = "red")
             )

```


#### Chord Diagram (2002 - 2014)

```{r fig.width=7, fig.height=6}

chordDiagramLand(dataset = SL_2002_2014$lulc_Onestep,
             legendtable = SL_2002_2014$tb_legend)

```

#### Sankey Multi Step

```{r, fig.width=8, fig.height=4}

sankeyLand(dataset = SL_2002_2014$lulc_Multistep,
           legendtable = SL_2002_2014$tb_legend)


```


```
           2002                 2008                2010                  2012                  2014
```

#### Sankey One Step

```{r, fig.width=8, fig.height=4}

sankeyLand(dataset = SL_2002_2014$lulc_Onestep,
           legendtable = SL_2002_2014$tb_legend)

```
```
                          2002                                                  2014
```

#### An Evolution Bar Plot

```{r, fig.width=7, fig.height=4}

barplotLand(dataset = SL_2002_2014$lulc_Multistep, 
          legendtable = SL_2002_2014$tb_legend,
          area_km2 = T,
          #panel.background = ggplot2::element_rect(fill = "grey85"),
          #panel.grid.major = ggplot2::element_line(colour = "red"),
          #axis.text = ggplot2::element_text(family = "serif",
                  #                          face = c("plain", "italic", "bold",
                                    #                 "bold.italic")[3], colour = "red")
                                                     )

```

## Other functions

OpenLand have others functions that helps having some quick summary over one or a series of raster. One of them is the `acc_chages()` when running over a series of raster it gives us as return a raster contains the number of times a pixel have been change during the period analysed and a table containing the percentage of every pixel value.


```{r}

# testacc <- acc_changes(SaoLourencoBasin)
# 
# testacc

```

Plotting the map with the `tmap` function:

```{r fig.height=7, fig.width=7}

# tmap_options(max.raster = c(plot = 41711112, view = 41711112))

# acc_map <- tmap::tm_shape(testacc[[1]]) +
#   tmap::tm_raster(
#     style = "cat",
#     labels = c(
#       paste0(testacc[[2]]$PxValue[1], " Change", " (", round(testacc[[2]]$Percent[1], 2), "%", ")"),
#       paste0(testacc[[2]]$PxValue[2], " Change", " (", round(testacc[[2]]$Percent[2], 2), "%", ")"),
#       paste0(testacc[[2]]$PxValue[3], " Changes", " (", round(testacc[[2]]$Percent[3], 2), "%", ")")
#     ),
#     palette = c("#757575", "#FFD700", "#CD0000"),
#     title = "Changes in the interval \n2002 - 2014"
#   ) +
#   tmap::tm_legend(
#     position = c(0.01, 0.2),
#     legend.title.size = 1.2,
#     legend.title.fontface = "bold",
#     legend.text.size = 0.8
#   ) +
#   tmap::tm_compass(type = "arrow",
#                    position = c("right", "top"),
#                    size = 3) +
#   tmap::tm_scale_bar(
#     breaks = c(seq(0, 40, 10)),
#     position = c(0.76, 0.001),
#     text.size = 0.6
#   ) +
#   tmap::tm_credits(
#     paste0(
#       "Case of Study site",
#       "\nAccumulate changes from 2002 to 2014",
#       "\nData create with OpenLand package",
#       "\nLULC derived from Embrapa Pantanal, Instituto SOS Pantanal, and WWF-Brasil 2015."
#     ),
#     size = 0.7,
#     position = c(0.01, -0, 01)
#   ) +
#   tmap::tm_graticules(
#     n.x = 6,
#     n.y = 6,
#     lines = FALSE,
#     #alpha = 0.1
#     labels.rot = c(0, 90)
#   ) +
#   tmap::tm_layout(inner.margins = c(0.02, 0.02, 0.02, 0.02))
# 
# 
# 
# 
# tmap::tmap_save(acc_map,
#                 filename = "vignettes/acc_mymap.png",
#                 width = 7,
#                 height = 7)


```

```{r mymap, echo=FALSE, fig.cap='Accumulate changes in pixel in the interval 2002 - 2014 in four time points (2002, 2008, 2010, 2012, 2014)', out.width='100%'}

knitr::include_graphics("acc_mymap.png")

```





# References
